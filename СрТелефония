// Модуль УТ10 для связи с телефонией Panasonic KX-HDV через отдельный веб сервер (хотя и напрямую можно)

Функция СрПолучитьТелефонПользователя (СрПеременная2) Экспорт
	// тестовая процедура
	Запрос = Новый Запрос;
	
	
	//Сообщить("Кто звонит_c: " + СрПеременная2);
	Запрос.Текст           = ""
	
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КонтактнаяИнформация.Представление,
	|	КонтактнаяИнформация.Тип,
	|	КонтактнаяИнформация.Вид,
	|	КонтактнаяИнформация.Комментарий
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &User";

	;
		
	    Запрос.УстановитьПараметр("User",СрПеременная2);
		//Сообщить("ЗАПРОС: " + Запрос.Текст);
		Результат =Запрос.Выполнить().Выгрузить();	
		
		


        //Результат.ВыбратьСтроку();
        Для Каждого Стр ИЗ Результат Цикл
			//Сообщить("стр "+Стр.Комментарий);
			
			//рез3="{value: 1}";
			//рез3 = СтрЗаменить(рез3,"""","");	
			//
			//Сообщить("ТЕКСТ "+рез3);
			//рез5 = ПрочитатьJSON(рез3);     	
			
			рез1=     Стр.Комментарий;
		КонецЦикла;    		
		
	    //Сообщить(рез2.comment);	

//Сообщить ("Результат запроса",Результат.Текст());
Возврат рез1;
КонецФункции

Процедура  СрОтправитьЗвонокНаТелефон (СрТелефонАбонента,СрPhoneipaddress) Экспорт
	Соединение = Новый HTTPСоединение(
        "192.168.0.79", // сервер (хост)
        80, // порт, по умолчанию для http используется 80, для https 443
        , // пользователь для доступа к серверу (если он есть)
        , // пароль для доступа к серверу (если он есть)
        , // здесь указывается прокси, если он есть
        , // таймаут в секундах, 0 или пусто - не устанавливать
          // защищенное соединение, если используется https
    );
	СрТелефонАбонента= СрТелефония.СрОбработатьНомер(СрТелефонАбонента);
	//Сообщить(СрТелефонАбонента);
	Структура = Новый Структура;
	Структура.Вставить ("MakeCall",СрТелефонАбонента);   			
	Структура.Вставить ("comment",СрPhoneipaddress);			
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Структура);
	СтрJSON = ЗаписьJSON.Закрыть(); 
	Запрос = Новый HTTPЗапрос("/MakeCallJSON/");
	Запрос.Заголовки.Вставить("Content-type", "application/json");
	Запрос.УстановитьТелоИзСтроки(СтрJSON,КодировкаТекста.UTF8,ИспользованиеByteOrderMark.НеИспользовать); 
	Результат = Соединение.ОтправитьДляОбработки(Запрос);

			//Результат = Соединение.Получить(Запрос);
	//Сообщить("Удачно выполнен ПОСТ запрос!");

			//Иначе
			//Сообщить(«Не выбран файл!»);
			//КонецЕсли;

			//И ВОТ
	//Сообщить("Нам вернули код: " + Результат.КодСостояния);
	
	
КонецПроцедуры

Функция СрОбработатьНомер (СрТелефонАбонента) Экспорт

	СрТелефонАбонента = СтрЗаменить(СрТелефонАбонента,", доб.", "");
	СрТелефонАбонента = СтрЗаменить(СрТелефонАбонента," ", ""); 
	СрТелефонАбонента = СтрЗаменить(СрТелефонАбонента,"(", "");
	СрТелефонАбонента = СтрЗаменить(СрТелефонАбонента,")", "");
	СрТелефонАбонента = СтрЗаменить(СрТелефонАбонента,"-", "");
	СрТелефонАбонента = СтрЗаменить(СрТелефонАбонента,"+7", "8");
	Возврат СрТелефонАбонента;
КонецФункции

Функция СрНайтиКонтакты (СрКонтрагент) Экспорт
	
	Запрос = Новый Запрос;      	
	//Сообщить("Кто звонит_c: " + СрПеременная2);
	Запрос.Текст           = ""		
		"ВЫБРАТЬ
		|	Телефон.Представление КАК Телефон
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КонтактнаяИнформация КАК Телефон
		|		ПО (Телефон.Объект = Контрагенты.Ссылка)
		|			И (Телефон.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон))
		|			И (Контрагенты.Ссылка = &Контрагент)
		|ГДЕ
		|	Контрагенты.Ссылка = &Контрагент
		|
		|УПОРЯДОЧИТЬ ПО
		|	Контрагенты.Наименование"
	;		
		
	//Результат.ВыбратьСтроку(0);
    Запрос.УстановитьПараметр("Контрагент",СрКонтрагент);
	//Сообщить("ЗАПРОС: " + Запрос.Текст);
	Результат =Запрос.Выполнить().Выгрузить();	
	//Сообщить(Результат);
		
		
	

	Для Каждого Стр1 ИЗ Результат Цикл
		//Сообщить("найден телефон контрагента: "+Стр1.Телефон);
		//НоваяСтрока = Результат2.Добавить();
		//НоваяСтрока.Должность = Контрагент;
		//НоваяСтрока.КонтактноеЛицо = Стр1.Контрагент;
		//НоваяСтрока.Должность = Стр1.Контрагент;
		//НоваяСтрока.Телефон = Стр1.Телефон;
	КонецЦикла;

		
		
	Запрос = Новый Запрос;      	
	//Сообщить("Кто звонит_c: " + СрПеременная2);
	
	Запрос.Текст           = ""     
		"ВЫБРАТЬ
		|	КонтактныеЛицаКонтрагентов.КонтактноеЛицо КАК КонтактноеЛицо,
		|	КонтактныеЛицаКонтрагентов.Должность КАК Должность,
		|	ВЫБОР
		|		КОГДА КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон)
		|			ТОГДА ЕСТЬNULL(КонтактнаяИнформация.Представление, """")
		|		ИНАЧЕ """"
		|	КОНЕЦ КАК Телефон
		|ИЗ
		|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаКонтрагентов КАК КонтактныеЛицаКонтрагентов
		|		ПО (КонтактнаяИнформация.Объект = КонтактныеЛицаКонтрагентов.Ссылка)
		|ГДЕ
		|	КонтактныеЛицаКонтрагентов.Владелец = &Контрагент
		|	И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Телефон)"
   		; 	
	
	    Запрос.УстановитьПараметр("Контрагент",СрКонтрагент);
		//Сообщить("ЗАПРОС: " + Запрос.Текст);
		Результат2 =Запрос.Выполнить().Выгрузить();	
		//Сообщить(Результат);
		
				
		
		Для Каждого Колонка Из Результат.Колонки Цикл
        	//Сообщить("Заголовок " + Колонка.Заголовок);

		КонецЦикла; 
		
		Для Каждого Стр1 ИЗ Результат Цикл
			//Сообщить(Стр1.Телефон);
			НоваяСтрока = Результат2.Добавить();
			//НоваяСтрока.Должность = Контрагент;
			НоваяСтрока.КонтактноеЛицо = СрКонтрагент;
			НоваяСтрока.Должность = СрКонтрагент;
			НоваяСтрока.Телефон = Стр1.Телефон;
		КонецЦикла;
		//КолонкиТЗ = Результат2.Колонки;  		
       	//КолонкиТЗ.Удалить("Должность"); 
		Результат2.Колонки.Удалить("Должность");
		
	Возврат Результат2;	
КонецФункции

